From 6bd2ea4b49ee4df1898c2de0e2947d512a6f7fb3 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Jonah=20Br=C3=BCchert?= <jbb@kaidan.im>
Date: Thu, 10 Jun 2021 14:17:39 +0200
Subject: [PATCH] Fix adding webapps in flatpak

---
 angelfish-webapp/main.cpp | 10 +++++++++-
 src/webappmanager.cpp     |  6 +++++-
 2 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/angelfish-webapp/main.cpp b/angelfish-webapp/main.cpp
index d27184d..8950d4d 100644
--- a/angelfish-webapp/main.cpp
+++ b/angelfish-webapp/main.cpp
@@ -28,6 +28,14 @@
 
 constexpr auto APPLICATION_ID = "org.kde.angelfish";
 
+QString desktopFileDirectory()
+{
+    if (!QStandardPaths::locate(QStandardPaths::RuntimeLocation, QStringLiteral("flatpak-info")).isEmpty()) {
+        return qEnvironmentVariable("HOME") % u"/.local/share/applications/";
+    }
+    return QStandardPaths::writableLocation(QStandardPaths::ApplicationsLocation);
+}
+
 Q_DECL_EXPORT int main(int argc, char *argv[])
 {
     QGuiApplication::setAttribute(Qt::AA_EnableHighDpiScaling);
@@ -67,7 +75,7 @@ Q_DECL_EXPORT int main(int argc, char *argv[])
     }
 
     const QString fileName = parser.positionalArguments().constFirst();
-    const KDesktopFile desktopFile(fileName);
+    const KDesktopFile desktopFile(desktopFileDirectory() % fileName);
     if (desktopFile.readUrl().isEmpty()) {
         return 2;
     }
diff --git a/src/webappmanager.cpp b/src/webappmanager.cpp
index bd974cc..99f34b7 100644
--- a/src/webappmanager.cpp
+++ b/src/webappmanager.cpp
@@ -6,6 +6,7 @@
 
 #include <QStandardPaths>
 #include <QImage>
+#include <QStringBuilder>
 
 #include <KDesktopFile>
 #include <KConfigGroup>
@@ -41,6 +42,9 @@ WebAppManager::WebAppManager(QObject *parent)
 
 QString WebAppManager::desktopFileDirectory()
 {
+    if (!QStandardPaths::locate(QStandardPaths::RuntimeLocation, QStringLiteral("flatpak-info")).isEmpty()) {
+        return qEnvironmentVariable("HOME") % u"/.local/share/applications/";
+    }
     return QStandardPaths::writableLocation(QStandardPaths::ApplicationsLocation);
 }
 
@@ -129,7 +133,7 @@ QString WebAppManager::webAppCommand()
                    "--command=angelfish-webapp "
                    "--filesystem=%1 "
                    "org.kde.angelfish")
-            .arg(QStandardPaths::writableLocation(QStandardPaths::ApplicationsLocation));
+            .arg(desktopFileDirectory());
     }
 
     return QStringLiteral("angelfish-webapp");
-- 
2.32.0

